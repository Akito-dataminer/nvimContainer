# 目標
Neovimでの編集環境を作成する。

## 問題意識
以下の2つの理由によって、実行環境にNeovimを入れたくない。

最近のソフトウェア開発ではDockerやnerdctlによって、コンテナ上で行うことが多い。
そのため、Neovimを使って開発する最も簡単な方法は、コンテナの内部でNeovimを起動する方法だろう。
しかし、それはソフトウェアの実行には関係の無いソフトウェアを実行環境に導入するということになる。
もしNeovimに関する修正を行う場合でも実行環境に影響が出るかもしれないし、
実行環境を変更すると、Neovimの環境が変わるかもしれない。

このような依存関係は望ましくない。

さらに、もしチームで開発しているなら、もしかしたらNeovimを使いたいという人はあなた一人かもしれない。
だとすると、大半の人に必要とされていないソフトウェアが実行環境に同梱されることになる。

これもやはり望ましくないだろう。

そこで、実行環境と開発環境を明確に分けられるような仕組みを作りたい。

# 運用方法
## 概略
0. .env.templateの各項目を埋めて.envとする。
1. 実行環境となるコンテナ(nvimContainerとは別に)を作成
2. `VOLUME, WORKSPACE, CONTAINER_NAME`を指定して、docker composeを実行
3. `./initial.sh`を実行して、環境情報を開発環境(nvimContainer)にコピー
4. `nvim --remote-ui --server localhost:6497`で、開発環境上のNeovimに接続
5. コードを編集

つまり最終的には、最低でも合計2つのコンテナが作られることになる。

## 詳細
### 1. 実行環境の作成
まず、実行環境をコンテナとして作成しておく。そのとき、そのコンテナが以下の2点を満たすようにしておく。

1. docker volume lsによって、ボリュームを外部から確認可能であること
2. /usr/以下がボリュームにマウントされていること

#### 条件1が要求されている理由
外部から確認可能なボリュームが作成されていなければ、「ボリュームを指定して、その内容をコピーする」という操作が不可能なので、
それが可能となるような実行環境コンテナを作る必要がある。

#### 条件2が要求されている理由
条件1と同様、「ボリュームを指定して、その内容をコピーする」という操作を可能とするためであるが、
ここではひとまず、実行環境と開発環境でコマンドとライブラリが同じであれば開発は可能だろうという考えによって、
コマンドとライブラリをrsyncによりコピーしている。

具体的には、

1. 開発環境の/usr/以下を、このリポジトリのコンテナ(開発環境)の/mnt/usr/以下にマウント
2. initial.shにより、/mnt/usr/以下を/usr/以下にコピー

という手順によって、上記の考えを実現している。その都合上、/usr/以下が外部からアクセス可能である必要がある。

#### 環境変数までは読み込んでいない
上記の説明から明らかではあろうが、説明しないままにしておくわけにもいくまい。
環境変数も開発環境にコピーするのが望ましい。しかし現状では、その手段を思い付けていない。
そのため、これは一旦保留としている。
何か良いアイデアがあったら、プルリクエストという形でも、メッセージという形でも構わないので、
ご教授いただけるとありがたい。

### 2. 実行環境コンテナの作成、実行
VOLUME、WORKSPACE、CONTAINER_NAMEの3つを指定した後、
`docker compose -f <開発したいプロジェクトのルート>`により、
コンテナイメージのビルドや、コンテナの起動を行う。

具体的には、例えば以下のようなコマンドとなる。
VOLUME=run_env WORKSPACE=$(pwd) CONTAINER_NAME=dev_env docker compose up

必要があれば、実行環境のコンテナを起動して、ボリュームを作成しておく。
そして、そのボリュームを以下のように指定し、

### 各種変数には何を指定するか
1. VOLUME: 実行環境コンテナのボリューム
2. WORKSPACE: 開発したいプロジェクトのルート
3. CONTAINER_NAME: このDockerfileをビルドした後、起動するコンテナの名前

この3番は後で指定したくなるかもしれないので、分かりやすい名前にしておくことを推奨したい。
例えばハッシュ値などはおすすめしない。
